# Public API
The Public API is the API intended to be exposed to clients outside the internal
infrastructure. It should be protected with the implementation of policies (see
PolicyAPI.md). 

One particularity about the public API is the managemnet of sessions. The
developer-gateway currently exposes an HTTP endpoint for the public API.
However, the nature of some of the exposed APIs is asynchronous, that is, it's
unclear when a response will be ready. So, we chose an asynchronous model for
the asynchronous APIs (Service Execute, Service Deploy). In this model, a
mailbox of messages is allocated per session and the client can poll that
mailbox to receive new notifications on the successes and failures of the
submitted requests.

This session oriented approach means that clients need to manage the sessions
and their mailboxes, discarding messages that they have already seen in order to
avoid exhausting the resources to which they have access.

## Service Execute
Execute is the main API call of the developer-gateway. Allows the execution of a
secure service function, with the user provided arguments. A request to execute
a service is implemented as

```go
// ExecuteServiceRequest is is used by the user to trigger a service
// execution. A client is always subscribed to a subcription with
// topic "service" from which the client can retrieve the asynchronous
// results to this request
type ExecuteServiceRequest struct {
	// Data is a blob of data that the user wants to pass to the service
	// as argument
	Data string `json:"data"`

	// Address where the service can be found
	Address string `json:"address"`
}
```

And the data of the request is confidential. Nobody except the runtime
environment has access to the arguments that will be passed on to the service
execution or which method will be called. If there needs to be restrictions on
what service functions can be called, they need to be implemented in the service itself.

The response to a service execution is an asyncrhonous response.

```go
// AsyncResponse is the response returned by APIs that are asynchronous
// that return an ID that can be used by the user to receive and identify
// a response to the request when it is ready
type AsyncResponse struct {
	// ID to identify an asynchronous response. It uniquely identifies the
	// event and orders it in the sequence of events expected by the user
	ID uint64 `json:"id"`
}
```

Executing a service is treated as an asynchronous operation because it is not
clear when the operation can complete (see Service Poll API for understanding of
how events are received). Executing a service is basically a submit operation,
and the response is the confirmation of that submission. The client receives a
response with an unique identifier for the `ExecuteServiceEvent` raised once the
execution completes.

```go
// ExecuteServiceEvent is the event that can be polled by the user
// as a result to a ServiceExecutionRequest
type ExecuteServiceEvent struct {
	// ID to identify an asynchronous response. It uniquely identifies the
	// event and orders it in the sequence of events expected by the user
	ID uint64 `json:"id"`

	// Address is the unique address that identifies the service,
	// is generated when a service is deployed and it can be used
	// for service execution
	Address string `json:"address"`

	// Output generated by the service at the end of its execution
	Output string `json:"output"`
}
```

In a curl request
```
curl -X POST https://developer-gateway/v0/api/service/execute \
  -i -H 'Content-type:application/json' -H 'X-OASIS-INSECURE-AUTH:myuser' \
  -H 'X-OASIS-SESSION-KEY:mykey' -d '{"data":"0x","address":"0x0000000000000000000000000000000000000000"}'
```

## Service Poll
Service polling allows clients to poll for events triggered by the submission to
requests. The requests that are asynchronous, Service Execute and Service
Deploy, return an ID that can later be polled with the Service Poll API. `For
example, an `ExecuteServiceRequest` triggers a `ExecuteServiceEvent` on
successful execution of the request. This event is stored in a session mailbox
that the client polls with a request

```go
// PollServiceRequest is a request that allows the user to
// poll for events either from asynchronous responses
type PollServiceRequest struct {
	// Offset at which events need to be provided. Events are all ordered
	// with sequence numbers and it is up to the client to specify which
	// events it wants to receive from an offset in the sequence
	Offset uint64 `json:"offset"`

	// Count for the number of items the client would prefer to receive
	// at most from a single response
	Count uint `json:"count"`

	// DiscardPrevious allows the client to define whether the server should
	// discard all the events that have a sequence number lower than the offer
	DiscardPrevious bool `json:"discardPrevious"`
}
```

For polling, the client and the server manage a window of events. The client is
free to poll for events and discard previous events that it has already received
(effectively an acknolwedgment). In case of an error in the execution of the
request, the client would receive an error event with the ID of the `AsyncResponse`.

```go
// ErrorEvent is the event that can be polled by the user
// as a result to a request that failed
type ErrorEvent struct {
	// ID to identifiy an asynchronous response. It uniquely identifies the
	// event and orders it in the sequence of events expected by the user
	ID uint64 `json:"id"`

	// Cause is the error that caused the event to failed
	Cause rpc.Error `json:"cause"`
}
```

In a curl request
```
curl -X POST https://developer-gateway/v0/api/service/poll \
  -i -H 'Content-type:application/json' -H 'X-OASIS-INSECURE-AUTH:myuser' \
  -H 'X-OASIS-SESSION-KEY:mykey' -d '{"id": 1, "offset": 0, "discardPrevious": true}'
```

## Service Deploy
Allows clients to deploy new contracts. It is possible that service providers
want to restrict access to this API to administrators, to have more fine grained
control on to which contracts normal users have access to.

The Service Deploy API works similarly to the Service Execute API. It submits
the deployment of a service to be executed as soon as possible, receiving an
asynchronous response. Later on the Service Poll API can be used to retrieve the
event generated to the request.

```go
// DeployServiceRequest is issued by the user to trigger a service
// execution. A client is always subscribed to a subcription with
// topic "service" from which the client can retrieve the asynchronous
// results to this request
type DeployServiceRequest struct {
	// Data is a blob of data that the user wants to pass as argument for
	// the deployment of a service
	Data string `json:"data"`
}
```

The immediate response to a `DeployServiceRequest` is 

```go
// AsyncResponse is the response returned by APIs that are asynchronous
// that return an ID that can be used by the user to receive and identify
// a response to the request when it is ready
type AsyncResponse struct {
	// ID to identify an asynchronous response. It uniquely identifies the
	// event and orders it in the sequence of events expected by the user
	ID uint64 `json:"id"`
}
```

The triggered event as a success response to the request is
```go
// DeployServiceEvent is the event that can be polled by the user
// as a result to a ServiceExecutionRequest
type DeployServiceEvent struct {
	// ID to identifiy an asynchronous response. It uniquely identifies the
	// event and orders it in the sequence of events expected by the user
	ID uint64 `json:"id"`

	// Address is the unique address that identifies the service,
	// is generated when a service is deployed and it can be used
	// for service execution
	Address string `json:"address"`
}
```

In a curl request
```
curl -X POST https://developer-gateway/v0/api/service/deploy \
  -i -H 'Content-type:application/json' -H 'X-OASIS-INSECURE-AUTH:myuser' \
  -H 'X-OASIS-SESSION-KEY:mykey' -d '{"data":"0x"}'
```

## Get Public Key
The developer-gateway implements secure services. That is, services that have
guarantees on the privacy and confidentiality that they can offer. The Get
Public Key request is used to retrieve the public key associated with a
contract. The client encrypts the arguments that it wants to submit to the
runtime with that key so that the payload is encrypted end-to-end, and no one,
not even the developer-gateway, has access to that data.

This is a synchronous request with a clear request-response definition

```
// GetPublicKeyRequest is a request to retrieve the public key
// associated with a specific service
type GetPublicKeyRequest struct {
	// Address is the unique address that identifies the service,
	// is generated when a service is deployed and it can be used
	// for service execution
	Address string `json:"address"`
}
```

```
// GetPublicKeyResponse is the response in which the public key
// associated with the contract is provided
type GetPublicKeyResponse struct {
	// Timestamp at which the public key expired
	Timestamp uint64 `json:"timestamp"`
	// Address is the unique address that identifies the service,
	// is generated when a service is deployed and it can be used
	// for service execution
	Address string `json:"address"`

	// PublicKey associated to the service
	PublicKey string `json:"publicKey"`

	// Signature generated by the key manager for authentication of the
	// public key
	Signature string `json:"signature"`
}
```

```
curl -X POST https://developer-gateway/v0/api/service/getPublicKey \
  -i -H 'Content-type:application/json' -H 'X-OASIS-INSECURE-AUTH:myuser' \
  -H 'X-OASIS-SESSION-KEY:mykey' -d '{"address": "0x0000000000000000000000000000000000000000"}'
```

## Subscribe
The Subscribe API allows the client to subscribe to events generated by the
execution of the service. The same implementation for managing subscriptions is
used to implement managing session mailboxes. The developer-gateway pushes all
the events that it receives to the subscription mailbox, that the client can
later on poll with the Poll Event API.

A subscribe request allows the client to specify the parameters of the subscription
```
// SubscribeRequest is used by the user to create a subscription to specific
// topics on the gateway.
type SubscribeRequest struct {
	// Events is the the list of event types the subscription intends
	// to be created for
	Events []string `json:"events"`

	// Filter is a url encoded list of query parameters that specifiy
	// filters to be applied to the subscribed topic
	Filter string `json:"filter"`
}
```

As the time of this writing, the only even type that is supported is `logs`. And
the supported filters are `address` and `topic`. So, a request could be send
with parameters 

```go
SubscribeRequest{
    Events: []string{"logs"},
    Filter: "address=0x0000000000000000000000000000000000000000&topic=mytopic",
}
```

And the response to a request has the ID of the subscription, so that the client
can issue poll requests for new events

```go
// AsyncResponse is the response returned by APIs that are asynchronous
// that return an ID that can be used by the user to receive and identify
// a response to the request when it is ready
type AsyncResponse struct {
	// ID to identify an asynchronous response. It uniquely identifies the
	// event and orders it in the sequence of events expected by the user
	ID uint64 `json:"id"`
}
```

In a curl request:
```
curl -X POST https://developer-gateway/v0/api/event/subscribe \
    -i -H 'Content-type:application/json' \
    -H 'X-OASIS-INSECURE-AUTH:myuser -H 'X-OASIS-SESSION-KEY:mykey' \
    -d '{"events": ["logs"], "filter": "address=0x0000000000000000000000000000000000000000&topic=0x0000000000000000000000000000000000000000"}
```

## Poll Event
The Poll Event API is the same model as the Poll Service API. It polls events
from a subscription. The request to poll events from a subscription is:

```go
// PollEventRequest is a request that allows the user to
// poll for events either from asynchronous requests or from
// subscriptions
type PollEventRequest struct {
	// ID is the id of the subscription returned in SubscribeResponse
	ID uint64 `json:"id"`

	// Offset at which events need to be provided. Events are all ordered
	// with sequence numbers and it is up to the client to specifiy which
	// events it wants to receive from an offset in the sequence
	Offset uint64 `json:"offset"`

	// Count for the number of items the client would prefer to receive
	// at most from a single response
	Count uint `json:"count"`

	// DiscardPrevious allows the client to define whether the server should
	// discard all the events that have a sequence number lower than the offer
	DiscardPrevious bool `json:"discardPrevious"`
}
```

The `DiscardPrevious` field can be used by the client to tell the
developer-gateway to discard all the events previous to the provided `Offset`.
The developer-gateway allocates some resources for a subscription, and if the
client does not discard events that it does not need, the resources may reach
its limit and the developer-gateway will not be able to store further events.

It also allows the client to handle things like connection failures, in which a
message was received but not processed. The client can make another poll request
to receive the same events that it received previously and process them later
on. The implementation is similar to a window of events that the client and
server keep. The server just restricts the amount of events the window can have,
and the client manages the offset at which the window starts to make sure it has
received all the events in the window and process the events at its own pace.

A response to a poll request

```go
// PollEventResponse is the list of events that are returned for
// a subscription or a group of asynchronous requests
type PollEventResponse struct {
	// Offset is the current offset at which the provided list of events
	// start
	Offset uint64 `json:"offset"`

	// Events is the list of events that the server has starting from
	// the provided Offset
	Events []Event `json:"events"`
}
```

That contains the base Offset at which the window is, and all the events that
the window of events can return based on the client's query. The client knows
the type of the event that it will receive based on the subscription type that
it has created.

In a curl request

```
curl -X POST https://developer-gateway/v0/api/event/poll \
    -i -H 'Content-type:application/json' \
    -H 'X-OASIS-INSECURE-AUTH:myuser -H 'X-OASIS-SESSION-KEY:mykey' \
    -d '{"id": 1, "offset": 0}'
```

## Unsubscribe
The API for destroying a subscription. A client should destroy a subscription
that it has created by submitting the ID of the subscription. The
developer-gateway limits the number of subscriptions a client can have. In that
case, the client should destroy subscriptions it is no longer using in order to
leave space for future subscriptions.

```
// UnsubscribeRequest is used by the user to destroy a subscription to specific
// topics on the gateway.
type UnsubscribeRequest struct {
	// ID of the subscription to be destroyed
	ID uint64 `json:"id"`
}
```

In a curl request:
```
curl -X POST https://developer-gateway/v0/api/event/unsubscribe \
    -i -H 'Content-type:application/json' \
    -H 'X-OASIS-INSECURE-AUTH:myuser -H 'X-OASIS-SESSION-KEY:mykey' \
    -d '{"id": 0}
```
